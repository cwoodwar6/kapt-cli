#!/usr/bin/env bash

red=`tput setab 1 2>/dev/null || true`
yellow=`tput setab 3 2>/dev/null || true`
green=`tput setab 2 2>/dev/null || true`
blue=`tput setab 4 2>/dev/null || true`
reset=`tput sgr0 2>/dev/null || true`
bold=`tput bold 2>/dev/null || true`

die ( ) {
    echo
    echo "${bold}${red} $* ${reset}"
    echo
    exit 1
}

ensure ( ) {
    command -v $1 >/dev/null 2>&1 || die "ERROR: '$1' could be found in your PATH. Please install $1. $2"
}

info ( ) {
    echo "${bold}${blue} $* ${reset}"
}

# Requires kotlin version 1.1.3+
ensure kotlin 'https://kotlinlang.org/'

# Load up arguments
source args

# Set KOTLIN_HOME
# export KOTLIN_HOME=$KOTLIN_HOME

# Step 1: Generate Stubs
info "RUNNING STEP 1..."
$KOTLIN_HOME/bin/kotlinc \
-no-reflect \
-no-stdlib \
-no-jdk \
-verbose \
-classpath $CLASSPATH \
-d $OUTPUT \
-Xbuild-file=$BUILD_FILE \
-module-name $MODULE_NAME \
-Xadd-compiler-builtins \
-Xload-builtins-from-dependencies \
-P plugin:org.jetbrains.kotlin.kapt3:aptMode=stubs,\
$AP_CLASSPATH,\
plugin:org.jetbrains.kotlin.kapt3:sources=$SOURCES,\
plugin:org.jetbrains.kotlin.kapt3:classes=$CLASSES,\
plugin:org.jetbrains.kotlin.kapt3:incrementalData=$INCREMENTAL_DATA,\
plugin:org.jetbrains.kotlin.kapt3:stubs=$STUBS,\
plugin:org.jetbrains.kotlin.kapt3:apoptions=$AP_OPTIONS,\
plugin:org.jetbrains.kotlin.kapt3:javacArguments=$JAVAC_ARGUMENTS,\
plugin:org.jetbrains.kotlin.kapt3:useLightAnalysis=true,\
plugin:org.jetbrains.kotlin.kapt3:correctErrorTypes=false,\
plugin:org.jetbrains.kotlin.kapt3:verbose=true \
-Xplugin=$ANNOTATION_PROCESSOR \
&& info "STEP 1 COMPLETE." || die "STEP 1 FAILED."

# Step 2: Run kapt
info "RUNNING STEP 2..."
$KOTLIN_HOME/bin/kotlinc \
-no-reflect \
-no-stdlib \
-no-jdk \
-verbose \
-classpath $CLASSPATH \
-d $OUTPUT \
-Xbuild-file=$BUILD_FILE \
-module-name $MODULE_NAME  \
-Xadd-compiler-builtins \
-Xload-builtins-from-dependencies \
-P plugin:org.jetbrains.kotlin.kapt3:aptMode=apt,\
$AP_CLASSPATH,\
plugin:org.jetbrains.kotlin.kapt3:sources=$SOURCES,\
plugin:org.jetbrains.kotlin.kapt3:classes=$CLASSES,\
plugin:org.jetbrains.kotlin.kapt3:incrementalData=$INCREMENTAL_DATA,\
plugin:org.jetbrains.kotlin.kapt3:stubs=$STUBS,\
plugin:org.jetbrains.kotlin.kapt3:apoptions=$AP_OPTIONS,\
plugin:org.jetbrains.kotlin.kapt3:javacArguments=$JAVAC_ARGUMENTS,\
plugin:org.jetbrains.kotlin.kapt3:useLightAnalysis=true,\
plugin:org.jetbrains.kotlin.kapt3:correctErrorTypes=false,\
plugin:org.jetbrains.kotlin.kapt3:verbose=true \
-Xplugin=$ANNOTATION_PROCESSOR \
&& info "STEP 2 COMPLETE." || die "STEP 2 FAILED."

# Step 3: Invoke kotlinc normally
info "RUNNING STEP 3..."
$KOTLIN_HOME/bin/kotlinc \
-no-reflect \
-verbose \
-classpath $CLASSPATH \
-d $OUTPUT \
-Xbuild-file=$BUILD_FILE \
-module-name $MODULE_NAME \
-Xadd-compiler-builtins \
-Xload-builtins-from-dependencies \
-Xplugin=$ANNOTATION_PROCESSOR \
&& info "STEP 3 COMPLETE." || die "STEP 3 FAILED."

# Step 4: Invoke javac
# javac \
# -source 7 \
# -target 7 \
# -sourcepath  \
# -g \ 
# -bootclasspath /Users/cwoodward/Library/Android/sdk/platforms/android-24/android.jar:/Users/cwoodward/Library/Android/sdk/platforms/android-24/optional/org.apache.http.legacy.jar \
# -processorpath /Users/cwoodward/Development/kotlin-dagger-example/buck-out/gen/.okbuck/cache/__com.google.code.findbugs.jsr305-3.0.1.jar__/com.google.code.findbugs.jsr305-3.0.1.jar:/Users/cwoodward/Development/kotlin-dagger-example/buck-out/gen/.okbuck/cache/__com.google.dagger.dagger-2.11.jar__/com.google.dagger.dagger-2.11.jar:/Users/cwoodward/Development/kotlin-dagger-example/buck-out/gen/.okbuck/cache/__com.google.dagger.dagger-compiler-2.11.jar__/com.google.dagger.dagger-compiler-2.11.jar:/Users/cwoodward/Development/kotlin-dagger-example/buck-out/gen/.okbuck/cache/__com.google.dagger.dagger-producers-2.11.jar__/com.google.dagger.dagger-producers-2.11.jar:/Users/cwoodward/Development/kotlin-dagger-example/buck-out/gen/.okbuck/cache/__com.google.errorprone.javac-9-dev-r3297-1-shaded.jar__/com.google.errorprone.javac-9-dev-r3297-1-shaded.jar:/Users/cwoodward/Development/kotlin-dagger-example/buck-out/gen/.okbuck/cache/__com.google.googlejavaformat.google-java-format-1.3.jar__/com.google.googlejavaformat.google-java-format-1.3.jar:/Users/cwoodward/Development/kotlin-dagger-example/buck-out/gen/.okbuck/cache/__com.google.guava.guava-21.0.jar__/com.google.guava.guava-21.0.jar:/Users/cwoodward/Development/kotlin-dagger-example/buck-out/gen/.okbuck/cache/__com.squareup.javapoet-1.7.0.jar__/com.squareup.javapoet-1.7.0.jar:/Users/cwoodward/Development/kotlin-dagger-example/buck-out/gen/.okbuck/cache/__javax.inject.javax.inject-1.jar__/javax.inject.javax.inject-1.jar:/Users/cwoodward/Development/kotlin-dagger-example/buck-out/gen/.okbuck/cache/__org.jetbrains.annotations-13.0.jar__/org.jetbrains.annotations-13.0.jar:/Users/cwoodward/Development/kotlin-dagger-example/buck-out/gen/.okbuck/cache/__org.jetbrains.kotlin.kotlin-annotation-processing-1.1.50.jar__/org.jetbrains.kotlin.kotlin-annotation-processing-1.1.50.jar:/Users/cwoodward/Development/kotlin-dagger-example/buck-out/gen/.okbuck/cache/__org.jetbrains.kotlin.kotlin-stdlib-1.1.50.jar__/org.jetbrains.kotlin.kotlin-stdlib-1.1.50.jar \
# -processor dagger.internal.codegen.ComponentProcessor \
# -verbose \
# -d /Users/cwoodward/Development/kotlin-dagger-example/buck-out/bin/app/lib__src_debug__classes \
# -s /Users/cwoodward/Development/kotlin-dagger-example/buck-out/annotation/app/__src_debug_gen__ \
# -classpath /Users/cwoodward/Development/kotlin-dagger-example/buck-out/gen/.okbuck/cache/__com.google.dagger.dagger-2.11.jar__/com.google.dagger.dagger-2.11.jar:/Users/cwoodward/Development/kotlin-dagger-example/buck-out/gen/.okbuck/cache/__javax.inject.javax.inject-1.jar__/javax.inject.javax.inject-1.jar:/Users/cwoodward/Development/kotlin-dagger-example/buck-out/gen/.okbuck/cache/__org.jetbrains.annotations-13.0.jar__/org.jetbrains.annotations-13.0.jar:/Users/cwoodward/Development/kotlin-dagger-example/buck-out/gen/.okbuck/cache/__org.jetbrains.kotlin.kotlin-stdlib-1.1.50.jar__/org.jetbrains.kotlin.kotlin-stdlib-1.1.50.jar:/Users/cwoodward/Development/kotlin-dagger-example/buck-out/gen/app/__src_debug#dummy_r_dot_java_dummyrdotjava_output__/src_debug#dummy_r_dot_java.jar:/Users/cwoodward/Development/kotlin-dagger-example/buck-out/gen/app/lib__build_config_debug__output/build_config_debug.jar:/Users/cwoodward/Library/Android/sdk/platforms/android-24/android.jar:/Users/cwoodward/Library/Android/sdk/platforms/android-24/optional/org.apache.http.legacy.jar:buck-out/bin/app/lib__src_debug__classes \
# @buck-out/gen/app/__src_debug__srcs
